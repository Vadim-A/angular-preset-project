# Интернационализация на проекте с помощтю инструмента  @angular/localize

## Описание изменений в проекте

На данном проекте внедрен механизм интернационализации i18n от Angular. Для этого в проект добавлена Dev-зависимость:

> ng add @angular/localize

и был модифицирован файл `polyfills.ts`, разкомментирована строка строка:

```ts
import '@angular/localize/init';
```

В катечстве примера, на напроекте реализован превод русской локализации, используемой по умолчанию, на английскую. Для этого в файле `angular.json` внесены следующие настройки:

```json
{
  ...
  "projects": {
    "angular-preset-project": {
      ...
      "architect": {
        ...
        "build": {
          ...
          "configurations": {
            "en-US": {
              "localize": ["en-US"],
              "fileReplacements": [
                {
                  "replace": "src/environments/i18n/i18n.ts",
                  "with": "src/environments/i18n/i18n.en-US.ts"
                }
              ]
            },
          }
        },
        "serve": {
          ...
          "configurations": {
            ...
            "en-US": {
              "browserTarget": "angular-preset-project:build:en-US"
            }
          }
        },
        "extract-i18n": {
          "builder": "@angular-devkit/build-angular:extract-i18n",
          "options": {
            "browserTarget": "angular-preset-project:build"
          }
        },
      },
      "i18n": {
        "sourceLocale": "ru",
        "locales": {
          "en-US": "i18n/messages.en-US.xlf"
        }
      }
    }
  },
  "defaultProject": "angular-preset-project"
}

```

Важно отметить, что при сборке с исользованием конфигурации `i18n` (с параметром `--localize`) автоматически регистрируются данные локализации для pipe, но при обычной сборки этого не происходит. Поэтому, для обычной сборки в каталог `src/environments/i18n` были добавленны файлы настройки под каждую локализацию. Значения этих настроек используются для указания нужной локали в провайдере `LOCALE_ID` в файле `app.module`:

```ts
// ...
import { LOCALE_ID, NgModule } from '@angular/core';
import { environment } from '../environments/environment';
import { registerLocaleData } from '@angular/common';
import localeRu from '@angular/common/locales/ru';
import { i18n_environment } from 'src/environments/i18n/i18n';

if (!environment.production) {
  switch (i18n_environment.localeId) {
    case 'ru-RU':
      registerLocaleData(localeRu, i18n_environment.localeId);
      break;
    default:
      break;
  }
}

@NgModule({
  // ...
  providers: [
    // ...
    ...(environment.production ? [] : [{ provide: LOCALE_ID, useValue: i18n_environment.localeId }]),
  ],
})
export class AppModule {}

```

В `packajes.json` были добавлены следующие команды:

```json
{
  ...
  "scripts": {
    ...
    "start:en-US": "npm run start -- --configuration=en-US",
    "build:prod-localize": "npm run ng -- build --configuration=production --localize",
    "extract-i18n": "ng extract-i18n --output-path i18n",
  },
}
```

Переводы хранятся в папке `i18n` и имеют в имени файла название локализации, например перевод для en-US находится в файле `messages.en-US.xlf`.

Файл без указание локализации `messages.xlf` является выгрузкой отмеченых специальном тегом фраз, которые необходимо перевести. Этот файл генерируется с помощью следующей команды:

> npm run extract-i18n

Далее на основе этого файла осуществляется перевод сторонними средствами и сохраняются в файлах с соответстующим названием.

Базовые примеры механизмов интернационализации можно посмотреть по url `/demo/i18n`. Для запуска проекта с локализацией en-US нужно выполнить следующую комманду:

> npm run start:en-US

Для сборки проекта во всех локалях, используется следующая команда:

> npm run build:prod-localize

По завершении данной команды, в папке distr будут лежать копии приложения под каждую локализацию. Для всех сборок добавляется **baseHref**. Для корректной работы, нужно настроить сервер. Пример настроек можно помотреть в файле `config/nginx.l10n.conf`. Проверить работоспособность можно в докер-контейнере на основе файла `Dockerfile.localize` выполнив команду:

> docker build -f Dockerfile.localize -t ng-preset-localize:v1 .

Важно иметь ввиду, что при обычной сборке (без параметра `--localize`) **baseHref** не добавляется. его можно добавить задав соответствующий параметр в команды.

***Важно: При изменении демонстрационного компонента DemoI18nComponent желательно обновить переводы, что бы они соответствовали текущему состоянию компоненты.*** 

## Рекомендации и чек-лист

При использовании данного инструмента нужно иметь ввиду следующие моменты:

1. Перевод осуществляется путем сборки приложения под каждую локаль (не в рантайме). Это значит, что будут несколько копий данного приложения. В рантайме, при переходе от одной локализации к другой, будет потеря состояния приложения.
2. При сборке с параметром `--localize` в приложение добавится **baseHref**. Нужно проверить, как будет работать приложение, если у него уже задано это свойство.
3. Идентификаторы текстов могут генерироваться автоматически, либо задаваться самостоятельно. Во 2м случае, нужно быть внимательным: если меняется текст, но при этом не меняется идентификатор, то средства перевода могут не заметить данных изменений, и использовать старый перевод для нового текста.